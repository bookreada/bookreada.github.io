<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <link href="/res/style.css" rel="stylesheet" />

    <dialog id="filesdialog">
        <form method="dialog">
            <ul id="filesdialog_items" style=""></ul>
            <div style="align-items: end; display: flex;justify-content: end;">
                <input type="submit" id="filesdialog_cancel" value="Cancel" />                
            </div>
        </form>
    </dialog>


    <!--<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>-->
    <script src="/res/vendor/lightning-fs.js"></script>
    <!--<script src="https://unpkg.com/isomorphic-git"></script>-->
    <script src="/res/vendor/isomorphic-git.js"></script>

    <script type="module">
//import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
import http from '/res/vendor/http.js'

/*
window.fs = new LightningFS('fs')
window.pfs = window.fs.promises

window.http = http;
*/

const fs = new LightningFS('fs'),
pfs = fs.promises;

import { showInitRepoDialog, showSelectFileDialog } from '/res/js/self.js';

showInitRepoDialog(http, pfs, fs).then(async repo => {
    const files = await repo.listFiles();
    await showSelectFileDialog(files).then(async selectedFile => {
      if (selectedFile) {
        const content = await repo.readFile(selectedFile);
        const injectUIHtmlString = `
            <button id='gotoEdit' style='position: absolute;inset-inline-start: 40px;inset-block-start: 40px;' 
                onClick='(function() {
                    window.location.href = '/edit.html#f=${encodeURIComponent(selectedFile)}';
                })();'>
                    Edit!
            </button>`;

        const parser = new DOMParser(),
            newDocument = parser.parseFromString(injectUIHtmlString  + content, 'text/html'),
            currentRoot = document.documentElement;
        document.replaceChild(newDocument.documentElement, currentRoot);
      }
    });
});
</script>
</html>