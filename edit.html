<!DOCTYPE html>
<html>
    <style>
        html, body, .c {
            height: 100%;
        }

        .c {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .c input {
            margin: 2rem;
        }
    </style>

    <!--<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>-->
    <script src="/res/lightning-fs.js"></script>
    <!--<script src="https://unpkg.com/isomorphic-git"></script>-->
    <script src="/res/isomorphic-git.js"></script>

    <script type="module">
    //import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
    import http from '/res/http.js'
    
    window.fs = new LightningFS('fs')
    window.pfs = window.fs.promises

    window.http = http;
    run();
    </script>

    <body>
        <div class="c">
            <h1>Please clone:</h1>
            
            <label for="user">Username:</label>
            <input type="text" id="user" name="user" required size="30" value="sdubtest" />
            
            <label for="email">Email:</label>
            <input type="text" id="email" name="email" required size="30" value="sdubtest1@gmail.com" />
            
            <label for="repo">Repository:</label>
            <input type="text" id="repo" name="repo" required size="100" value="https://github.com/sdubtest/sdubtest.github.io.git" />
            
            <!--
            <label for="token">Token:</label>
            <input type="password" id="token" name="token" required size="10" />
            -->
            <button onClick='(function() { initRepo();  })();'>Clone now!</button>
        </div>
    </body>

    <script>

function injectDOM(templateString) {
    const htmlString = templateString.replaceAll(/\$\[([^\\]+?)\]/gi, (m, p1) => {
        const splitVal = p1.split(':'),
                name = splitVal[0],
                type = splitVal.length > 1 ? splitVal[1] : '';
        const val = `<button id='__id_${name}' onClick='(function() { __called("${name}", "${type}"); })();'>${name}</button>`;
        if (documentValues.hasOwnProperty(name)) {
            console.log(`warn: The name '${name}' is already used!`);
        }
        documentValues[name] = name;
        return val;
    });
    const injectUIHtmlString = `
        <button style='position: absolute;inset-inline-start: 40px;inset-block-start: 40px;' 
            onClick='(function() { createDocumentSource(); })();'>
                Speichern!
        </button>`;
    const parser = new DOMParser();
    const newDocument = parser.parseFromString(injectUIHtmlString  + htmlString, 'text/html');
    const currentRoot = document.documentElement;
    document.replaceChild(newDocument.documentElement, currentRoot);
}

function __called(name, type) {
    documentValues[name] = prompt('Neuer Inhalt?', documentValues[name]);
    document.getElementById(`__id_${name}`).innerText = documentValues[name];
}

function createDocumentSource() {
    let htmlString = templateSourceString;
    for (const name of Object.keys(documentValues)) {
        const value = documentValues[name],
                startIdx = htmlString.indexOf(`$[${name}`),
                endIdx = htmlString.indexOf(']', startIdx + 1);
        htmlString = htmlString.substring(0, startIdx) + value + htmlString.substring(endIdx + 1, htmlString.length);
    }
    addToRepo(htmlString);
}

function generateIndexHtml(existingPages) {
    let part = '';
    for (let n = 0; n <= existingPages; n++) {
        part = part + `<ol><a href="/pages/page_${n}.html">Page #${n}</ol>`;
    }

    return `<!DOCTYPE html>
<ul>
    ${part}
</ul>
<html>
    `;
}

async function addToRepo(htmlString) {
    let pagesDir = [];
    try {
        pagesDir = await pfs.readdir(`${dir}/pages`);
    } catch (e) {
    }

    if (pagesDir.length === 0) {
        try {
            await pfs.mkdir(`${dir}/pages`);
        } catch(e) {
        }
    }
    const pagesLen = pagesDir.length + 1;
    const fname = `pages/page_${pagesLen}.html`;

    await pfs.writeFile(`${dir}/${fname}`, htmlString, 'utf8');
    await pfs.writeFile(`${dir}/index.html`, generateIndexHtml(pagesLen), 'utf8');

    const stat1 = await git.status({fs, dir, filepath: fname});
    const stat2 = await git.status({fs, dir, filepath: 'index.html'});

    const add1 = await git.add({fs, dir, filepath: fname});
    const add2 = await git.add({fs, dir, filepath: 'index.html'});

    let sha = await git.commit({
        fs,
        dir,
        message: `Added ${fname}.`,
        author: {
            name: user,
            email: email,
        }
    });

    const pw = prompt('Password or Token, please.')

    let pushResult = await git.push({
        fs,
        http,
        dir,
        remote: 'origin',
        ref: 'main',
        onAuth: () => ({ username: pw }),
    })
    console.log(pushResult)
}

const documentValues = {};
let templateSourceString;

async function run() {

    window.dir = '/dubs';

    document.getElementById('repo').addEventListener('keydown', e => {
        if (e.code === "Enter") {
            initRepo();
        }
    });

    //todo check if login data if available from LocalStorage ..
}

async function initRepo() {
    window.user = document.getElementById("user").value;
    window.email = document.getElementById("email").value;
    window.repo = document.getElementById("repo").value;

    await cloneRepo(repo);
    await readRepo();
}

async function readRepo() {
    let readDir3 = await pfs.readdir(dir);
    if (readDir3.includes('_templates')) {
        let templateDir = await pfs.readdir(`${dir}/_templates`);
// todo show menu to let user select which template to use
        for (const templateFilePath of templateDir) {
            const templateSource = await pfs.readFile(`${dir}/_templates/${templateFilePath}`);

            templateSourceString = new TextDecoder().decode(templateSource);

            injectDOM(templateSourceString);
        }
    }
}

async function cloneRepo(repoUrl) {
    let readDir = [];
    try {
        readDir = await pfs.readdir(dir);
    } catch (e) {
    }

    if (readDir.length === 0) {
        try {
        /*let mkDir = */await pfs.mkdir(dir);
        } catch(e) {
        }
    }        
    //const repoUrl = prompt('repo url?', 'https://github.com/isomorphic-git/isomorphic-git')

    let readDir2 = await pfs.readdir(dir);

    // Do I have to `clone` every time I want to access the files?
    // Even after having `clone`d before if this does not happen every time
    // it only contains `.git`!?

    let cloneRes = await git.clone({
        fs,
        http,
        dir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: repoUrl,//'https://github.com/isomorphic-git/isomorphic-git',
        ref: 'main',
        singleBranch: true,
        depth: 1,
        onAuth: url => {
            const username = user
                    pw = prompt('Password or Token, please.');
            return {
                username: pw,
                //password: pw,
            };
        }
    });
}
    </script>
</html>