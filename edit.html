<!DOCTYPE html>
<html>
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html, body, .c {
            height: 100%;
        }

        .c {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .c input {
            margin: 2rem;
        }
    </style>

    <!--<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>-->
    <script src="/res/lightning-fs.js"></script>
    <!--<script src="https://unpkg.com/isomorphic-git"></script>-->
    <script src="/res/isomorphic-git.js"></script>

    <script type="module">
    //import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
    import http from '/res/http.js'
    
    window.fs = new LightningFS('fs')
    window.pfs = window.fs.promises

    window.http = http;
    run();
    </script>
    </head>
    <body>
        <div class="c">
            <h1>Please clone:</h1>
            
            <label for="user">Username:</label>
            <input type="text" id="user" name="user" required size="30" value="sdubtest" />
            
            <label for="email">Email:</label>
            <input type="text" id="email" name="email" required size="30" value="sdubtest1@gmail.com" />
            
            <label for="repo">Repository:</label>
            <input type="text" id="repo" name="repo" required size="40" value="https://github.com/sdubtest/sdubtest.github.io.git" />
            
            <!--
            <label for="token">Token:</label>
            <input type="password" id="token" name="token" required size="10" />
            -->

            <progress id="progress" value="0" max="100" style="visibility: hidden;"></progress>

            <button id='clone' onClick='(function() { 
                    document.getElementById("clone").setAttribute("disabled", "disabled");
                    showProgress(true);
                    setProgress(5);
                    initRepo();  
                })();'>Clone now!</button>
        </div>
    </body>

    <script>

function setProgress(num) {
    document.getElementById("progress").value = num;
}

function showProgress(show) {
    document.getElementById("progress").style = "visibility: " + show ? "visible" : "hidden";
}

function injectDOM(templateString) {
    const htmlString = templateString.replaceAll(/\$\[([^\\]+?)\]/gi, (m, p1) => {
        const splitVal = p1.split(':'),
                name = splitVal[0],
                type = splitVal.length > 1 ? splitVal[1] : '';
        const val = `<button id='__id_${name}' onClick='(function() { 
                __called("${name}", "${type}"); 
            })();'>${name}</button>`;
        if (documentValues.hasOwnProperty(name)) {
            console.log(`warn: The name '${name}' is already used!`);
        }
        documentValues[name] = name;
        return val;
    });
    const injectUIHtmlString = `
        <button id='save' style='position: absolute;inset-inline-start: 40px;inset-block-start: 40px;' 
            onClick='(function() { 
                document.getElementById("save").setAttribute("disabled", "disabled");
                showProgress(true);
                setProgress(5);
                createDocumentSource(); 
            })();'>
                Speichern!
        </button>
        <progress id="progress" value="0" max="100" style="visibility: hidden;"></progress>`;
    const parser = new DOMParser();
    const newDocument = parser.parseFromString(injectUIHtmlString  + htmlString, 'text/html');
    const currentRoot = document.documentElement;
    document.replaceChild(newDocument.documentElement, currentRoot);
}

function __called(name, type) {
    const val = prompt('Neuer Inhalt?', documentValues[name]);
    if (val) {
        documentValues[name] = val;
        document.getElementById(`__id_${name}`).innerText = documentValues[name];
    }
}

function createDocumentSource() {
    let htmlString = templateSourceString;
    for (const name of Object.keys(documentValues)) {
        const value = documentValues[name],
                startIdx = htmlString.indexOf(`$[${name}`),
                endIdx = htmlString.indexOf(']', startIdx + 1);
        htmlString = htmlString.substring(0, startIdx) + value + htmlString.substring(endIdx + 1, htmlString.length);
    }
    setProgress(20);
    addToRepo(dir, htmlString);
}

function generateIndexHtml(existingPages) {
    let part = '';
    for (let n = 1; n <= existingPages; n++) {
        part = part + `<ol><a href="/pages/page_${n}.html">Page #${n}</ol>`;
    }

    return `<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
</head>
<body>
<ul>
    ${part}
</ul>
</body>
<html>`;
}

async function addToRepo(localDir, htmlString) {
    let pw = prompt('Password or Token, please.');
    if (!pw) {
        showProgress(false);
        return;
    }

    setProgress(50);
    let pagesDir = [];
    try {
        pagesDir = await pfs.readdir(`${localDir}/pages`);
    } catch (e) {
    }

    if (pagesDir.length === 0) {
        try {
            await pfs.mkdir(`${localDir}/pages`);
        } catch(e) {
        }
    }
    const pagesLen = pagesDir.length + 1;
    const fname = `pages/page_${pagesLen}.html`;

    await pfs.writeFile(`${localDir}/${fname}`, htmlString, 'utf8');
    await pfs.writeFile(`${localDir}/index.html`, generateIndexHtml(pagesLen), 'utf8');

    const stat1 = await git.status({fs, localDir, filepath: fname});
    const stat2 = await git.status({fs, localDir, filepath: 'index.html'});

    const add1 = await git.add({fs, localDir, filepath: fname});
    const add2 = await git.add({fs, localDir, filepath: 'index.html'});
    setProgress(60);
    let sha = await git.commit({
        fs,
        dir: localDir,
        message: `Added ${fname}.`,
        author: {
            name: user,
            email: email,
        }
    });
    setProgress(70);
    let pushResult = await git.push({
        fs,
        http,
        dir: localDir,
        remote: 'origin',
        ref: 'main',
        onAuth: () => ({ username: pw }),
    });
    setProgress(100);
    // todo give more feedback, esp. in case of err..
    console.log(pushResult)
    setTimeout(() => {
        showProgress(false);
    }, 500);
}

const dir = '/dubs';
const documentValues = {};
let templateSourceString;

async function run() {
    document.getElementById('repo').addEventListener('keydown', e => {
        if (e.code === "Enter") {
            initRepo();
        }
    });

    //todo check if login data if available from LocalStorage ..
}

async function initRepo() {
    window.user = document.getElementById("user").value;
    window.email = document.getElementById("email").value;
    window.repo = document.getElementById("repo").value;

    const dir = '/dubs';
    await cloneRepo(dir, repo);
    await readRepo(dir);
}

async function readRepo(localDir) {
    let readDir = await pfs.readdir(localDir);
    if (readDir.includes('_templates')) {
        let templateDir = await pfs.readdir(`${localDir}/_templates`);
// todo show menu to let user select which template to use
        for (const templateFilePath of templateDir) {
            const templateSource = await pfs.readFile(`${localDir}/_templates/${templateFilePath}`);

            templateSourceString = new TextDecoder().decode(templateSource);

            setProgress(80);

            injectDOM(templateSourceString);
        }
    }
}

async function cloneRepo(localDir, repoUrl) {
    let readDir = [];
    try {
        readDir = await pfs.readdir(localDir);
    } catch (e) {
    }

    if (readDir.length === 0) {
        try {
            await pfs.mkdir(localDir);
        } catch(e) {
        }
    }        

    readDir = await pfs.readdir(localDir);

    if (window.localStorage.getItem('repoUrl') === repoUrl) {
        if (readDir.length > 1) {
            setProgress(90);
            return;
        }
    } else {
        window.localStorage.setItem('repoUrl', repoUrl);
    }

    setProgress(10);

    let cloneRes = await git.clone({
        fs,
        http,
        dir: localDir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: repoUrl,//'https://github.com/isomorphic-git/isomorphic-git',
        ref: 'main',
        singleBranch: true,
        depth: 1,
        onAuth: url => {
            const username = user
                    pw = prompt('Password or Token, please.');
            return {
                username: pw,
                //password: pw,
            };
        }
    });

    setProgress(90);
}
    </script>
</html>