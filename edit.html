<!DOCTYPE html>
<html>
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html, body, .c {
            height: 95%;
        }
        
        .c {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .c input {
            margin: 2rem;
        }
    </style>

    <!--<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>-->
    <script src="/res/lightning-fs.js"></script>
    <!--<script src="https://unpkg.com/isomorphic-git"></script>-->
    <script src="/res/isomorphic-git.js"></script>

    <script type="module">
    //import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
    import http from '/res/http.js'
    
    window.fs = new LightningFS('fs')
    window.pfs = window.fs.promises

    window.http = http;
    run();
    </script>
    </head>
    <body>
        <div class="c">
            <h1>Please clone:</h1>
            
            <label for="user">Username:</label>
            <input type="text" id="user" name="user" required size="30" value="sdubtest" />
            
            <label for="email">Email:</label>
            <input type="text" id="email" name="email" required size="30" value="sdubtest1@gmail.com" />
            
            <label for="repo">Repository:</label>
            <input type="text" id="repo" name="repo" required size="40" value="https://github.com/sdubtest/sdubtest.github.io.git" />
            
            <!--
            <label for="token">Token:</label>
            <input type="password" id="token" name="token" required size="10" />
            -->

            <progress id="progress" value="0" max="100" style="visibility: hidden;"></progress>

            <button id='clone' onClick='(function() { 
                    enable("clone", false);
                    showProgress(true);
                    setProgress(5);
                    initRepo();  
                })();'>Clone now!</button>
        </div>
    </body>

    <script>

function setProgress(num) {
    document.getElementById("progress").value = num;
}

function showProgress(show) {
    document.getElementById("progress").style = "visibility: " + (show ? "visible" : "hidden");
}

function enable(what, really) {
    if (really) {
        document.getElementById(what).removeAttribute("disabled");
    } else {
        document.getElementById(what).setAttribute("disabled", "disabled");
    }
}

function __called(name, type) {
    const val = prompt('Neuer Inhalt?', documentValues[name].value);
    if (val) {
        documentValues[name].value = val;
        document.getElementById(`__id_${name}`).innerText = documentValues[name].value;
    }
}

function injectDOM(templateString) {
    const attachUploadHandlers = [];
    const htmlString = templateString.replaceAll(/\$\[([^\\]+?)\]/gi, (m, p1) => {
        const splitVal = p1.split(':'),
                // why do templator author have to specify a name they cannot reference? ;-) 
                // could just generate a random identifier and care only about type..
                name = splitVal[0],
                type = splitVal.length > 1 ? splitVal[1] : '';

        let val;
        if (type === 'Image') {
            val = `<div style="display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: row;">
                        <img id='__preview_${name}' />
                        <form id='__fid_${name}'>
                            <label for='__fileInput_${name}'>Choose an image:</label>
                            <input type='file' id='__fileInput_${name}' accept='image/png, image/jpeg' required>
                            <button type='submit'>OK</button>
                        </form>
                    </div>`;
            attachUploadHandlers.push(name);
        } else {
            val = `<button id='__id_${name}' 
                    onClick='(function() { 
                        __called("${name}", "${type}"); 
                    })();'>${name}</button>`;
        }
        
        if (documentValues.hasOwnProperty(name)) {
            console.log(`warn: The name '${name}' is already used!`);
        }
        documentValues[name] = {value: name, type: type};
        return val;
    });
    const injectUIHtmlString = `
        <button id='save' style='position: absolute;inset-inline-start: 40px;inset-block-start: 40px;' 
            onClick='(function() { 
                enable('save', false);
                showProgress(true);
                setProgress(5);
                saveNewDocumentToRepo(); 
            })();'>
                Speichern!
        </button>
        <progress id="progress" value="0" max="100" style="visibility: hidden;"></progress>`;
    const parser = new DOMParser(),
        newDocument = parser.parseFromString(injectUIHtmlString  + htmlString, 'text/html'),
        currentRoot = document.documentElement;
    document.replaceChild(newDocument.documentElement, currentRoot);

    attachUploadHandlers.forEach(name => {
        document.getElementById(`__fid_${name}`).addEventListener('submit', async function(event) {
            event.preventDefault();

            const fileInput = document.getElementById(`__fileInput_${name}`),
                file = fileInput.files[0],
                byteFile = await getAsByteArray(file),
                blob = new Blob([byteFile], {type: file.type}),
                urlCreator = window.URL || window.webkitURL,
                imageUrl = urlCreator.createObjectURL(blob);
            
            documentValues[name].value = byteFile;
            documentValues[name].mimetype = file.type;
            
            document.getElementById(`__preview_${name}`).src = imageUrl;
            document.getElementById(`__fid_${name}`).style = "visibility: hidden";
            // todo this would be nice:
            document.getElementById(`__preview_${name}`).addEventListener('onclick', () => document.getElementById(`__fid_${name}`).submit());
        });
    });
}

function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.addEventListener('loadend', e => resolve(e.target.result));
    reader.addEventListener('error', reject);
    reader.readAsArrayBuffer(file);
  })
}

async function getAsByteArray(file) {
  return new Uint8Array(await readFile(file));
}

async function preparePagesDir(localDir) {
    let pagesDir = [];
    try {
        pagesDir = await pfs.readdir(`${localDir}/pages`);
    } catch (e) {
    }

    if (pagesDir.length === 0) {
        try {
            await pfs.mkdir(`${localDir}/pages`);
        } catch(e) {
        }
    }
    return pagesDir;
}

async function saveNewDocumentToRepo() {
    let pw = prompt('Password or Token, please.');
    if (!pw) {
        showProgress(false);
        enable('save', true);
        return;
    }

    setProgress(30);
    const localDir = dir,
        pagesDir = await preparePagesDir(localDir),
        pagesLen = pagesDir.length + 1,
        fname = `pages/page_${pagesLen}.html`,
        files = [],
        folders = [];

    let htmlString = templateSourceString;
    for (const name of Object.keys(documentValues)) {
        const type = documentValues[name].type,
                startIdx = htmlString.indexOf(`$[${name}`),
                endIdx = htmlString.indexOf(']', startIdx + 1);

        let value;
        if (type === 'Image') {
            let suff;
            if (documentValues[name].mimetype === 'image/jpeg') {
                suff = 'jpg';
            } else {
                suff = 'png';
            }
            const len = files.length + 1,
                foldername = `pages/files_${pagesLen}`,
                fname = `${foldername}/img_${len}.${suff}`;
            if (!folders.includes(foldername)) {
                folders.push(foldername);
            }
            files.push({
                name: fname,
                content: documentValues[name].value
            });
            value = `<img src='/${fname}'>`;
        } else {
            value = documentValues[name].value;
        }
        htmlString = htmlString.substring(0, startIdx) + value + htmlString.substring(endIdx + 1, htmlString.length);
    }
    setProgress(20);

    await pfs.writeFile(`${localDir}/${fname}`, htmlString, 'utf8');
    await git.add({fs, dir: localDir, filepath: fname});

    await pfs.writeFile(`${localDir}/index.html`, generateIndexHtml(pagesLen), 'utf8');
    await git.add({fs, dir: localDir, filepath: 'index.html'});

    for (const folder of folders) {
        try {
            await pfs.mkdir(`${localDir}/${folder}`);
        } catch(e) {
        }
    }

    for (const file of files) {
        await pfs.writeFile(`${localDir}/${file.name}`, file.content);
        await git.add({fs, dir: localDir, filepath: file.name});
    }

    setProgress(60);
    const sha = await git.commit({
        fs,
        dir: localDir,
        message: `Added ${fname}.`,
        author: {
            name: user,
            email: email,
        }
    });
    setProgress(70);
    const pushResult = await git.push({
        fs,
        http,
        dir: localDir,
        remote: 'origin',
        ref: 'main',
        onAuth: () => ({ username: pw }),
    });

    if (!pushResult.ok) {
        alert('Sorry -.- That did not work..');
    }
    console.log(pushResult);    
    setProgress(100);
    setTimeout(() => {
        showProgress(false);
    }, 500);
}

function generateIndexHtml(existingPages) {
    let part = '';
    for (let n = 1; n <= existingPages; n++) {
        part = part + `<ol><a href="/pages/page_${n}.html">Page #${n}</ol>`;
    }

    return `<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
</head>
<body>
<ul>
    ${part}
</ul>
</body>
<html>`;
}

const dir = '/dubs';
const documentValues = {};
let templateSourceString;

async function run() {
    document.getElementById('repo').addEventListener('keydown', e => {
        if (e.code === "Enter") {
            initRepo();
        }
    });

    //todo check if login data if available from LocalStorage ..
}

async function initRepo() {
    window.user = document.getElementById("user").value;
    window.email = document.getElementById("email").value;
    window.repo = document.getElementById("repo").value;

    await cloneRepo(dir, repo);
    await readRepo(dir);
}

async function readRepo(localDir) {
    let readDir = await pfs.readdir(localDir);
    if (readDir.includes('_templates')) {
        let templateDir = await pfs.readdir(`${localDir}/_templates`);
// todo show menu to let user select which template to use
        for (const templateFilePath of templateDir) {
            const templateSource = await pfs.readFile(`${localDir}/_templates/${templateFilePath}`);
            templateSourceString = new TextDecoder().decode(templateSource);
            setProgress(80);
            injectDOM(templateSourceString);
        }
    }
}

async function cloneRepo(localDir, repoUrl) {
    let readDir = [];
    try {
        readDir = await pfs.readdir(localDir);
    } catch (e) {
    }

    if (readDir.length === 0) {
        try {
            await pfs.mkdir(localDir);
        } catch(e) {
        }
    }

    readDir = await pfs.readdir(localDir);

    if (window.localStorage.getItem('repoUrl') === repoUrl) {
        if (readDir.length > 1) {
            setProgress(90);
            return;
        }
    } else {
        window.localStorage.setItem('repoUrl', repoUrl);
    }

    setProgress(10);
    // todo is there a callback to show progress while cloning?
    let cloneRes = await git.clone({
        fs,
        http,
        dir: localDir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: repoUrl,//'https://github.com/isomorphic-git/isomorphic-git',
        ref: 'main',
        singleBranch: true,
        depth: 1,
        onAuth: url => {
            const username = user
                    pw = prompt('Password or Token, please.');
            return {
                username: pw,
                //password: pw,
            };
        }
    });

    setProgress(90);
}
    </script>
</html>